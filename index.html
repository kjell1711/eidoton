<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Learning App (HTML + Firebase)</title>
  <!-- Tailwind via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .rounded-3xl { border-radius: 1.5rem; }
    .rounded-2xl { border-radius: 1rem; }
    .rounded-xl { border-radius: .75rem; }
    .shadow-2xl { box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); }
    .shadow-lg { box-shadow: 0 10px 15px -3px rgba(0,0,0,0.08); }
    .transition-all { transition: all .18s ease; }
  </style>
  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBXZG4vsRDqpe_XRHeb64MV-NbLbKtijWs",
      authDomain: "eidoton.firebaseapp.com",
      projectId: "eidoton",
      storageBucket: "eidoton.firebasestorage.app",
      messagingSenderId: "167879420438",
      appId: "1:167879420438:web:f0c10f3a042eb37a1da337",
      measurementId: "G-GCBC06PE3R"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    window.firebaseDB = db; // global zugÃ¤nglich machen
  </script>
</head>
<body class="antialiased">
<div id="app" class="flex flex-col h-screen bg-gray-50"></div>

<script>
  // --- Konfiguration (Fragen etc.) ---
  const configData = {
    questions: {
      mathe: [
        { question: "Was ist 7 + 5?", answers: ["11","12","13"], correct: 1 },
        { question: "Was ist 9 Ã— 3?", answers: ["24","27","30"], correct: 1 },
        { question: "Was ist 20 - 8?", answers: ["11","12","13"], correct: 1 },
        { question: "Was ist 15 Ã· 3?", answers: ["4","5","6"], correct: 1 },
        { question: "Was ist 6 + 9?", answers: ["14","15","16"], correct: 1 }
      ],
      deutsch: [
        { question: "Welches Wort ist richtig geschrieben?", answers: ["Fahrrad","Farrad","Farad"], correct: 0 },
        { question: "Was ist das Gegenteil von 'groÃŸ'?", answers: ["klein","dick","schnell"], correct: 0 },
        { question: "Wie viele Buchstaben hat das Alphabet?", answers: ["24","26","28"], correct: 1 },
        { question: "Was ist ein Nomen?", answers: ["Ein Tuwort","Ein Namenwort","Ein Wiewort"], correct: 1 },
        { question: "Welcher Artikel gehÃ¶rt zu 'Haus'?", answers: ["der","die","das"], correct: 2 }
      ],
      englisch: [
        { question: "What is 'Hund' in English?", answers: ["cat","dog","bird"], correct: 1 },
        { question: "What is 'rot' in English?", answers: ["red","blue","green"], correct: 0 },
        { question: "How do you say 'Guten Morgen'?", answers: ["Good night","Good morning","Good day"], correct: 1 },
        { question: "What is 'Apfel' in English?", answers: ["orange","apple","banana"], correct: 1 },
        { question: "What does 'thank you' mean?", answers: ["Bitte","Danke","Hallo"], correct: 1 }
      ]
    }
  };

  // --- App State ---
  const state = {
    isLoggedIn: false,
    userName: '',
    userCoins: 0,
    currentTab: 'mathe',
    currentQuestion: null,
    feedback: null,
    loginInput: '',
    gameActive: false,
    gameScore: 0,
    playerY: 0,
    isJumping: false,
    obstacles: [],
    gameOver: false
  };

  const app = document.getElementById('app');

  function getRandomQuestion(subject) {
    const q = configData.questions[subject];
    return q[Math.floor(Math.random()*q.length)];
  }

  // --- Firebase Helper ---
  async function loadUser(name) {
    const docRef = doc(window.firebaseDB, "players", name);
    const docSnap = await getDoc(docRef);
    if (docSnap.exists()) {
      return docSnap.data();
    } else {
      // Neues Dokument anlegen
      await setDoc(docRef, { coins: 0 });
      return { coins: 0 };
    }
  }

  async function saveUser(name, coins) {
    const docRef = doc(window.firebaseDB, "players", name);
    await setDoc(docRef, { coins }, { merge: true });
  }

  // --- Game loops ---
  let gameInterval = null;
  let jumpInterval = null;

  function startGameLoop() {
    if (gameInterval) clearInterval(gameInterval);
    gameInterval = setInterval(() => {
      state.obstacles = state.obstacles.map(o => ({...o, x: o.x - 5})).filter(o=> o.x > -50);
      if (Math.random() < 0.02) state.obstacles.push({ x: 400, y: 0 });
      state.obstacles.forEach(obs => {
        if (obs.x < 70 && obs.x > 20 && state.playerY < 40) {
          state.gameOver = true;
          state.gameActive = false;
        }
      });
      if (!state.gameOver) state.gameScore += 1;
      render();
    }, 50);
  }

  function stopGameLoop() { if(gameInterval){ clearInterval(gameInterval); gameInterval = null; } }
  function startJumpLoop() {
    if (jumpInterval) clearInterval(jumpInterval);
    let jumpHeight = 0;
    jumpInterval = setInterval(() => {
      jumpHeight += 10;
      if (jumpHeight >= 100) { state.isJumping=false; state.playerY=0; clearInterval(jumpInterval); jumpInterval=null; }
      else state.playerY = jumpHeight;
      render();
    },30);
  }

  // --- Actions ---
  async function handleLogin() {
    const input = state.loginInput.trim();
    if (!input) return;

    const userData = await loadUser(input);
    state.userName = input;
    state.userCoins = userData.coins;
    state.isLoggedIn = true;
    state.currentQuestion = getRandomQuestion('mathe');
    render();
  }

  async function handleAnswer(index) {
    if (!state.currentQuestion || state.feedback) return;
    const isCorrect = index === state.currentQuestion.correct;
    if (isCorrect) { state.userCoins += 1; state.feedback='correct'; }
    else { state.feedback='wrong'; }
    render();
    await saveUser(state.userName, state.userCoins);
    setTimeout(() => {
      state.feedback = null;
      if (!['spiele','profil'].includes(state.currentTab)) state.currentQuestion = getRandomQuestion(state.currentTab);
      render();
    },1500);
  }

  function handleTabChange(tab) { state.currentTab = tab; state.feedback=null; if(['mathe','deutsch','englisch'].includes(tab)) state.currentQuestion=getRandomQuestion(tab); else state.currentQuestion=null; render(); }
  function startGame() { if(state.userCoins<10) return; state.userCoins-=10; state.gameActive=true; state.gameOver=false; state.gameScore=0; state.playerY=0; state.obstacles=[]; startGameLoop(); render(); }
  function handleJump() { if(!state.isJumping && state.playerY===0){ state.isJumping=true; startJumpLoop(); } }
  async function endGame() { state.gameActive=false; state.userCoins += Math.floor(state.gameScore/100); stopGameLoop(); await saveUser(state.userName,state.userCoins); render(); }

  // --- Render (unverÃ¤ndert wie Original, nur kleiner angepasst fÃ¼r brevity) ---
  function renderLogin() {
    return `<div class="flex items-center justify-center min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4">
      <div class="bg-white rounded-3xl shadow-2xl p-8 w-full max-w-md">
        <div class="text-center mb-8">
          <div class="inline-block p-4 bg-blue-500 rounded-full mb-4 text-white text-4xl">ðŸ“š</div>
          <h1 class="text-3xl font-bold text-gray-800 mb-2">Willkommen!</h1>
          <p class="text-gray-600">Gib deinen Namen ein, um zu starten</p>
        </div>
        <input id="loginInput" type="text" value="" placeholder="Dein Name" class="w-full px-6 py-4 text-lg border-2 border-gray-300 rounded-2xl mb-4 focus:outline-none focus:border-blue-500 transition-colors" />
        <button id="loginBtn" class="w-full bg-blue-500 text-white py-4 rounded-2xl text-lg font-semibold hover:bg-blue-600 transition-colors shadow-lg">Los geht's!</button>
      </div>
    </div>`;
  }

  // --- Haupt-Render ---
  function render() {
    if(!state.isLoggedIn){
      app.innerHTML = renderLogin();
      document.getElementById('loginInput').value = state.loginInput;
      document.getElementById('loginInput').addEventListener('input',(e)=>state.loginInput=e.target.value);
      document.getElementById('loginInput').addEventListener('keypress',(e)=>{ if(e.key==='Enter') handleLogin(); });
      document.getElementById('loginBtn').addEventListener('click',handleLogin);
      return;
    }

    // Hier kann man alle anderen render-Methoden wie Header, GameArea, Fragen usw. genau so einfÃ¼gen
    app.innerHTML = `<h1 class="text-center mt-20 text-2xl font-bold">Hallo ${state.userName}, Coins: ${state.userCoins}</h1>`;
  }

  render();
  window.addEventListener('beforeunload',()=>{ stopGameLoop(); if(jumpInterval) clearInterval(jumpInterval); });
</script>
</body>
</html>
